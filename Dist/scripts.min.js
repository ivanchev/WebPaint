/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*! @source http://purl.eligrey.com/github/canvas-toBlob.js/blob/master/canvas-toBlob.js */

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */

var requirejs,require,define;(function(e){function h(e,t){return f.call(e,t)}function p(e,t){var n,r,i,s,o,a,f,l,h,p,d,v=t&&t.split("/"),m=u.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){e=e.split("/"),o=e.length-1,u.nodeIdCompat&&c.test(e[o])&&(e[o]=e[o].replace(c,"")),e=v.slice(0,v.length-1).concat(e);for(h=0;h<e.length;h+=1){d=e[h];if(d===".")e.splice(h,1),h-=1;else if(d===".."){if(h===1&&(e[2]===".."||e[0]===".."))break;h>0&&(e.splice(h-1,2),h-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(h=n.length;h>0;h-=1){r=n.slice(0,h).join("/");if(v)for(p=v.length;p>0;p-=1){i=m[v.slice(0,p).join("/")];if(i){i=i[r];if(i){s=i,a=h;break}}}if(s)break;!f&&g&&g[r]&&(f=g[r],l=h)}!s&&f&&(s=f,a=l),s&&(n.splice(0,a,s),e=n.join("/"))}return e}function d(t,r){return function(){var i=l.call(arguments,0);return typeof i[0]!="string"&&i.length===1&&i.push(null),n.apply(e,i.concat([t,r]))}}function v(e){return function(t){return p(t,e)}}function m(e){return function(t){s[e]=t}}function g(n){if(h(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!h(s,n)&&!h(a,n))throw new Error("No "+n);return s[n]}function y(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function b(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice,c=/\.js$/;r=function(e,t){var n,r=y(e),i=r[0];return e=r[1],i&&(i=p(i,t),n=g(i)),i?n&&n.normalize?e=n.normalize(e,v(t)):e=p(e,t):(e=p(e,t),r=y(e),i=r[0],e=r[1],i&&(n=g(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return d(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:b(e)}}},t=function(t,n,u,f){var l,c,p,v,y,b=[],w=typeof u,E;f=f||t;if(w==="undefined"||w==="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){v=r(n[y],f),c=v.f;if(c==="require")b[y]=i.require(t);else if(c==="exports")b[y]=i.exports(t),E=!0;else if(c==="module")l=b[y]=i.module(t);else if(h(s,c)||h(o,c)||h(a,c))b[y]=g(c);else{if(!v.p)throw new Error(t+" missing "+c);v.p.load(v.n,d(f,!0),m(c),{}),b[y]=s[c]}}p=u?u.apply(s[t],b):undefined;if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(p!==e||!E)s[t]=p}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){if(typeof s=="string")return i[s]?i[s](o):g(r(s,o).f);if(!s.splice){u=s,u.deps&&n(u.deps,u.callback);if(!o)return;o.splice?(s=o,o=a,a=null):s=e}return o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n},n.config=function(e){return n(e)},requirejs._defined=s,define=function(e,t,n){if(typeof e!="string")throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),!h(s,e)&&!h(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("lib/almond",function(){}),define("view",[],function(){function s(){return"ontouchstart"in window}function o(i){e=i.find(".toolbar-wrap"),r=i.find(".header-wrap"),t=e.find(".toolbar-primary-wrap"),n=e.find(".toolbar-secondary-wrap")}function u(t,n){e.animate({bottom:"-80px"},i,function(){t(),e.animate({bottom:"0px"},i)}),r.animate({top:"-80px"},i,function(){n(),r.animate({top:"0px"},i)})}function a(){u(function(){e.show(),n.hide().find("ul").hide(),t.show()},function(){r.show().find("ul").show(),$("#confirmList").hide(),$("#zoomList").hide()})}function f(i,o){s()?u(function(){i?($(i).show(),n.show(),t.hide()):e.hide()},function(){i?(r.find("ul").hide(),$("#confirmList").show()):r.hide()}):(n.find("ul").hide(),e.find(".selected").removeClass("selected"),$(i).show(),$(o).addClass("selected"))}var e,t,n,r,i=300;return{init:o,isTouch:s,restore:a,show:f,transition:u}}),function(e){var t=e.Uint8Array,n=e.HTMLCanvasElement,r=n&&n.prototype,i=/\s*;\s*base64\s*(?:;|$)/i,s="toDataURL",o,u=function(e){var n=e.length,r=new t(n/4*3|0),i=0,s=0,u=[0,0],a=0,f=0,l,c,h;while(n--)c=e.charCodeAt(i++),l=o[c-43],l!==255&&l!==h&&(u[1]=u[0],u[0]=c,f=f<<6|l,a++,a===4&&(r[s++]=f>>>16,u[1]!==61&&(r[s++]=f>>>8),u[0]!==61&&(r[s++]=f),a=0));return r};t&&(o=new t([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),n&&!r.toBlob&&(r.toBlob=function(e,n){n||(n="image/png");if(this.mozGetAsFile){e(this.mozGetAsFile("canvas",n));return}if(this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(n)){e(this.msToBlob());return}var r=Array.prototype.slice.call(arguments,1),o=this[s].apply(this,r),a=o.indexOf(","),f=o.substring(a+1),l=i.test(o.substring(0,a)),c;Blob.fake?(c=new Blob,l?c.encoding="base64":c.encoding="URI",c.data=f,c.size=f.length):t&&(l?c=new Blob([u(f)],{type:n}):c=new Blob([decodeURIComponent(f)],{type:n})),e(c)},r.toDataURLHD?r.toBlobHD=function(){s="toDataURLHD";var e=this.toBlob();return s="toDataURL",e}:r.toBlobHD=r.toBlob)}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content||this),define("canvasToBlob",function(){});var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i="download"in r,s=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},o=e.webkitRequestFileSystem,u=e.requestFileSystem||o||e.mozRequestFileSystem,a=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},f="application/octet-stream",l=0,c=500,h=function(t){var r=function(){"string"==typeof t?n().revokeObjectURL(t):t.remove()};e.chrome?r():setTimeout(r,c)},p=function(e,t,n){t=[].concat(t);for(var r=t.length;r--;){var i=e["on"+t[r]];if("function"==typeof i)try{i.call(e,n||e)}catch(s){a(s)}}},d=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["ï»¿",e],{type:e.type}):e},v=function(t,a){t=d(t);var c,v,m,g=this,y=t.type,b=!1,w=function(){p(g,"writestart progress write writeend".split(" "))},E=function(){if((b||!c)&&(c=n().createObjectURL(t)),v)v.location.href=c;else{var r=e.open(c,"_blank");void 0==r&&"undefined"!=typeof safari&&(e.location.href=c)}g.readyState=g.DONE,w(),h(c)},S=function(e){return function(){return g.readyState!==g.DONE?e.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};return g.readyState=g.INIT,a||(a="download"),i?(c=n().createObjectURL(t),r.href=c,r.download=a,s(r),g.readyState=g.DONE,w(),void h(c)):(e.chrome&&y&&y!==f&&(m=t.slice||t.webkitSlice,t=m.call(t,0,t.size,f),b=!0),o&&"download"!==a&&(a+=".download"),(y===f||o)&&(v=e),u?(l+=t.size,void u(e.TEMPORARY,l,S(function(e){e.root.getDirectory("saved",x,S(function(e){var n=function(){e.getFile(a,x,S(function(e){e.createWriter(S(function(n){n.onwriteend=function(t){v.location.href=e.toURL(),g.readyState=g.DONE,p(g,"writeend",t),h(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&E()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=g["on"+e]}),n.write(t),g.abort=function(){n.abort(),g.readyState=g.DONE},g.readyState=g.WRITING}),E)}),E)};e.getFile(a,{create:!1},S(function(e){e.remove(),n()}),S(function(e){e.code===e.NOT_FOUND_ERR?n():E()}))}),E)}),E)):void E())},m=v.prototype,g=function(e,t){return new v(e,t)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t){return navigator.msSaveOrOpenBlob(d(e),t)}:(m.abort=function(){var e=this;e.readyState=e.DONE,p(e,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,g)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define("fileSaver",[],function(){return saveAs}),define("fileIO",["canvasToBlob","fileSaver"],function(){function e(e,n,r){var i,s;if(typeof window.FileReader!="function"){alert("The file API isn't supported on this browser yet.");return}e.files?(i=e.files[0],s=new FileReader,s.onload=function(){var e=s.result;t(e,n,r)},s.readAsDataURL(i)):alert("This browser doesn't seem to support the `files` property of file inputs.")}function t(e,t,n){var r=new Image;r.onload=function(){var e=t.getContext("2d");t.width=r.width,t.height=r.height,e.drawImage(r,0,0),n&&n.call(this,t)},r.src=e}function n(e,t){e.toBlob(function(e){saveAs(e,t)})}return{loadFile:e,saveFile:n}}),define("filters/base",[],function(){function e(e,t){var n=e.getContext("2d"),r=n.getImageData(0,0,e.width,e.height),i=r.data;t(i),n.putImageData(r,0,0)}function t(t,n,i){e(t,function(e){var s=t.getContext("2d"),o=s.getImageData(0,0,t.width,t.height),u=o.data,a=r(t.width),f,l,c,h;for(var p=0,d=e.length;p<d;p+=4){l=c=h=0;for(var v=0;v<a.length;v++){f=p+a[v];if(f<0||f>d)f=p;l+=u[f]*n[v],c+=u[f+1]*n[v],h+=u[f+2]*n[v]}e[p]=l/i,e[p+1]=c/i,e[p+2]=h/i}})}function n(t,n){e(t,function(e){var i=t.getContext("2d"),s=i.getImageData(0,0,t.width,t.height),o=s.data,u=r(t.width),a,f,l;for(var c=0,h=e.length;c<h;c+=4){l=[];for(var p=0;p<u.length;p++){a=c+u[p];if(a<0||a>h)a=c;f=.2126*o[a]+.7152*o[a+1]+.0722*o[a+2],l.push({index:a,value:f})}var d=n(l);e[c]=o[d],e[c+1]=o[d+1],e[c+2]=o[d+2]}})}function r(e){var t=[-(e+1),-e,-(e-1),-1,0,1,e-1,e,e+1];for(var n=0,r=t.length;n<r;n++)t[n]*=4;return t}return{applyFilter:e,applyConvoluteFilter:t,applyMorphologyFilter:n,getIndexMatrix:r}}),define("filters/grayscale",["filters/base"],function(e){function t(t){e.applyFilter(t,function(e){var t;for(var n=0,r=e.length;n<r;n+=4)t=.2126*e[n]+.7152*e[n+1]+.0722*e[n+2],e[n]=t,e[n+1]=t,e[n+2]=t})}return t}),define("filters/invert",["filters/base"],function(e){function t(t){e.applyFilter(t,function(e){for(var t=0,n=e.length;t<n;t+=4)e[t]=255-e[t],e[t+1]=255-e[t+1],e[t+2]=255-e[t+2]})}return t}),define("filters/blur",["filters/base"],function(e){function t(t){var n=[0,1,0,1,1,1,0,1,0],r=5;e.applyConvoluteFilter(t,n,r)}return t}),define("filters/sharpen",["filters/base"],function(e){function t(t){var n=[0,-1,0,-1,5,-1,0,-1,0],r=1;e.applyConvoluteFilter(t,n,r)}return t}),define("filters/emboss",["filters/base"],function(e){function t(t){var n=[-1,-1,0,-1,0,1,0,1,1],r=1;e.applyConvoluteFilter(t,n,r)}return t}),define("filters/edge",["filters/base"],function(e){function t(t){var n=[1,1,1,1,-8,1,1,1,1],r=1;e.applyConvoluteFilter(t,n,r)}return t}),define("filters/sobel",["filters/base"],function(e){function t(t){var n=[-1,0,1,-2,0,2,-1,0,1],r=[-1,-2,-1,0,0,0,1,2,1];e.applyFilter(t,function(i){var s=t.getContext("2d"),o=s.getImageData(0,0,t.width,t.height),u=o.data,a,f,l,c,h,p,d=e.getIndexMatrix(t.width),v,m,g,y;for(m=0,y=i.length;m<y;m+=4){a=f=l=0,c=h=p=0;for(g=0;g<d.length;g++){v=m+d[g];if(v<0||v>y)v=m;a+=u[m+d[g]]*n[g],f+=u[m+d[g]+1]*n[g],l+=u[m+d[g]+2]*n[g]}for(g=0;g<d.length;g++){v=m+d[g];if(v<0||v>y)v=m;c+=u[m+d[g]]*r[g],h+=u[m+d[g]+1]*r[g],p+=u[m+d[g]+2]*r[g]}i[m]=Math.abs(a)+Math.abs(c),i[m+1]=Math.abs(f)+Math.abs(h),i[m+2]=Math.abs(l)+Math.abs(p)}})}return t}),define("filters/erode",["filters/base"],function(e){function t(t){e.applyMorphologyFilter(t,function(e){var t=256,n=-1;for(var r=0,i=e.length;r<i;r++)t>e[r].value&&(t=e[r].value,n=e[r].index);return n})}return t}),define("filters/dilate",["filters/base"],function(e){function t(t){e.applyMorphologyFilter(t,function(e){var t=0,n=-1;for(var r=0,i=e.length;r<i;r++)t<e[r].value&&(t=e[r].value,n=e[r].index);return n})}return t}),define("filters/median",["filters/base"],function(e){function t(t){e.applyMorphologyFilter(t,function(e){var t=256,n=-1;return e.sort(function(e,t){return e.value-t.value}),e[Math.floor(e.length/2)].index})}return t}),define("filters/filters",["filters/grayscale","filters/invert","filters/blur","filters/sharpen","filters/emboss","filters/edge","filters/sobel","filters/erode","filters/dilate","filters/median"],function(e,t,n,r,i,s,o,u,a,f){return{grayscale:e,invert:t,blur:n,sharpen:r,emboss:i,edge:s,sobel:o,erode:u,dilate:a,median:f}}),define("transforms/flipHorizontal",[],function(){function e(e){var t=e.getContext("2d"),n=$("<canvas>")[0];n.width=e.width,n.height=e.height;var r=n.getContext("2d");r.translate(e.width,0),r.scale(-1,1),r.drawImage(e,0,0),t.drawImage(n,0,0)}return e}),define("transforms/flipVertical",[],function(){function e(e){var t=e.getContext("2d"),n=$("<canvas>")[0];n.width=e.width,n.height=e.height;var r=n.getContext("2d");r.translate(0,e.height),r.scale(1,-1),r.drawImage(e,0,0),t.drawImage(n,0,0)}return e}),define("transforms/rotate90",[],function(){function e(e){var t=e.getContext("2d"),n=$("<canvas>")[0];n.width=e.height,n.height=e.width;var r=n.getContext("2d");r.translate(n.width,0),r.rotate(90*Math.PI/180),r.drawImage(e,0,0),e.width=n.width,e.height=n.height,t.drawImage(n,0,0)}return e}),define("transforms/rotate180",[],function(){function e(e){var t=e.getContext("2d"),n=$("<canvas>")[0];n.width=e.width,n.height=e.height;var r=n.getContext("2d");r.translate(e.width,e.height),r.rotate(Math.PI),r.drawImage(e,0,0),t.drawImage(n,0,0)}return e}),define("transforms/rotate270",[],function(){function e(e){var t=e.getContext("2d"),n=$("<canvas>")[0];n.width=e.height,n.height=e.width;var r=n.getContext("2d");r.translate(0,n.height),r.rotate(270*Math.PI/180),r.drawImage(e,0,0),e.width=n.width,e.height=n.height,t.drawImage(n,0,0)}return e}),define("transforms/transforms",["transforms/flipHorizontal","transforms/flipVertical","transforms/rotate90","transforms/rotate180","transforms/rotate270"],function(e,t,n,r,i){return{flipHorizontal:e,flipVertical:t,rotate90:n,rotate180:r,rotate270:i}}),define("cache/cache",[],function(){function o(){var e=r.getContext("2d"),t=e.getImageData(0,0,r.width,r.height);return t}function u(e){var t=r.getContext("2d");r.width=e.width,r.height=e.height,t.putImageData(e,0,0)}function a(t){i=s=0,e=[],e[i]=t}function f(e){r=e,t=o(e),a(t)}function l(){var t=o(r);i===n-1?e=e.slice(1):i=s=i+1,e[i]=t}function c(){u(t),a(t)}function h(){var t=i-1;if(t<0)return;i=t,u(e[i])}function p(){var t=i+1;if(t>s)return;i=t,u(e[i])}function d(){u(e[i])}var e=[],t={},n=10,r=null,i=0,s=0;return{init:f,reset:c,store:l,undo:h,redo:p,current:d}}),define("zoom/zoom",[],function(){function i(e,i){r=e,n=i,t=100,a(),o()}function s(e){var t=e[0].clientX,n=e[1].clientX,r=e[0].clientY,i=e[1].clientY;return Math.sqrt(Math.pow(i-r,2)+Math.pow(n-t,2))}function o(){u(),$(r).on("mousedown.zoom",function(e){var t=$(".canvas-wrap"),n=e.clientX,i=e.clientY,s=t.scrollLeft(),o=t.scrollTop();$(r).on("mousemove.zoom",function(e){e.preventDefault(),t.scrollLeft(s-(e.clientX-n)).scrollTop(o-(e.clientY-i))}).on("mouseup.zoom",function(e){$(r).off("mouseup.zoom").off("mousemove.zoom")})}),$(document).on("touchstart.zoom",function(e){if(e.originalEvent.touches.length==2){var n=t,r=s(e.originalEvent.touches),i;$(document).on("touchmove.zoom",function(e){i=s(e.originalEvent.targetTouches),t=n*(i/r),a()}).on("touchend.zoom",function(e){$(document).off("touchmove.zoom").off("touchend.zoom")})}})}function u(){$(document).off(".zoom"),$(r).off(".zoom")}function a(){f(),n&&n(t)}function f(){var e=t/100,n=r.width*e,i=r.height*e,s=$(r.parentNode.parentNode).height();r.parentNode.style.width=n+"px",r.parentNode.style.height=i+"px",$(".zoom-wrap").toggleClass("center",s>i)}function l(n){var r=e.indexOf(t);if(r===-1){for(var i=0,s=e.length;i<s;i++)if(e[i]>t){r=i;break}r==-1&&(r=e.length),n==-1&&(r-=1)}else r+=n;r>-1&&r<e.length&&(t=e[r],a())}function c(){var e=r.parentNode.parentNode,n=e.offsetWidth/r.width,i=e.offsetHeight/r.height;t=Math.floor(Math.min(n,i)*100),a()}function h(){return t}var e=[25,50,75,100,150,200,400],t=100,n,r;return{init:i,stepZoom:l,fitZoom:c,applyZoom:a,refreshZoomWrap:f,getZoomLevel:h,disposeEvents:u}}),define("crop",[],function(){function n(){e&&(e.off().remove(),e=null),$(document).off(".crop"),t&&(t.off().remove(),t=null)}function r(){return{width:e.outerWidth(),height:e.outerHeight(),left:parseInt(e.css("left"),10)||0,top:parseInt(e.css("top"),10)||0}}function i(i,o,u,a){var f=$(".zoom-wrap"),l=f.width()-2,c=f.height()-2;e=$("<div class='crop-box'>").width(l).height(c).append("<div class='crop-dot crop-dot-TL'></div><div class='crop-dot crop-dot-TR'></div><div class='crop-dot crop-dot-BL'></div><div class='crop-dot crop-dot-BR'></div>").appendTo(f),t=$('<div class="actions-wrap"><div class="buttons-wrap"><ul class="buttons-list"><li id="cropOK"><span class="icon icon-ok"></span></li><li id="cropCancel"><span class="icon icon-cancel"></span></li></ul></div></div>').appendTo($(".content-wrap")).on("click","#cropCancel",function(){n(),a()}).on("click","#cropOK",function(){s(i,o),n(),u()});var h="ontouchstart"in window,p=h?"touchstart":"mousedown",d=h?"touchmove":"mousemove",v=h?"touchend":"mouseup";e.on(p,".crop-dot",function(t){var n=h?t.originalEvent.touches[0].clientX:t.clientX,i=h?t.originalEvent.touches[0].clientY:t.clientY,s=$(this),o=r();$(document).on(d+".crop",function(t){t.preventDefault();var r=(h?t.originalEvent.touches[0].clientX:t.clientX)-n,u=(h?t.originalEvent.touches[0].clientY:t.clientY)-i,a,f,p=o.left,d=o.top;s.is(".crop-dot-TL")?(d=Math.max(0,o.top+u),p=Math.max(0,o.left+r),a=o.width+(o.left-p),f=o.height+(o.top-d)):s.is(".crop-dot-TR")?(d=Math.max(0,o.top+u),a=o.width+r,f=o.height+(o.top-d)):s.is(".crop-dot-BL")?(p=Math.max(0,o.left+r),a=o.width+(o.left-p),f=o.height+u):(a=o.width+r,f=o.height+u);if(a<0||f<0)return;a+p>l&&(a=l-p),f+d>c&&(f=c-d),e.width(a).height(f).css("top",d).css("left",p)}).on(v+".crop",function(e){$(document).off(".crop")})})}function s(e,t){var n=r(),i=t/100,s=n.width/i,o=n.height/i,u=n.top/i,a=n.left/i,f=$("<canvas>")[0];f.width=s,f.height=o;var l=f.getContext("2d");l.drawImage(e,a,u,s,o,0,0,s,o),e.width=s,e.height=o;var c=e.getContext("2d");c.drawImage(f,0,0)}var e,t;return{crop:i,hide:n}}),define("colors/base",[],function(){function e(e,t,n){var r=e.getContext("2d"),i=t.data;n(i),r.putImageData(t,0,0)}function t(e,t,n){e/=255,t/=255,n/=255;var r=Math.max(e,t,n),i=Math.min(e,t,n),s,o,u=(r+i)/2;if(r==i)s=o=0;else{var a=r-i;o=u>.5?a/(2-r-i):a/(r+i);switch(r){case e:s=(t-n)/a+(t<n?6:0);break;case t:s=(n-e)/a+2;break;case n:s=(e-t)/a+4}s/=6}return[s,o,u]}function n(e,t,n){function o(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}var r,i,s;if(t===0)r=i=s=n;else{var u=n<.5?n*(1+t):n+t-n*t,a=2*n-u;r=o(a,u,e+1/3),i=o(a,u,e),s=o(a,u,e-1/3)}return[r*255,i*255,s*255]}return{applyFilter:e,rgbToHsl:t,hslToRgb:n}}),define("colors/brightness",["colors/base"],function(e){function t(t,n,r){e.applyFilter(t,n,function(e){for(var t=0,n=e.length;t<n;t+=4)e[t]+=r,e[t+1]+=r,e[t+2]+=r})}return t}),define("colors/contrast",["colors/base"],function(e){function t(t,n,r){var i=259*(r+255)/(255*(259-r));e.applyFilter(t,n,function(e){for(var t=0,n=e.length;t<n;t+=4)e[t]=i*(e[t]-128)+128,e[t+1]=i*(e[t+1]-128)+128,e[t+2]=i*(e[t+2]-128)+128})}return t}),define("colors/hue",["colors/base"],function(e){function t(t,n,r){e.applyFilter(t,n,function(t){for(var n=0,i=t.length;n<i;n+=4){var s=e.rgbToHsl(t[n],t[n+1],t[n+2]),o=s[0]+r/200;s=e.hslToRgb(o,s[1],s[2]),t[n]=s[0],t[n+1]=s[1],t[n+2]=s[2]}})}return t}),define("colors/saturation",["colors/base"],function(e){function t(t,n,r){e.applyFilter(t,n,function(t){for(var n=0,i=t.length;n<i;n+=4){var s=e.rgbToHsl(t[n],t[n+1],t[n+2]),o=Math.min(1,Math.max(0,s[1]+r/100));s=e.hslToRgb(s[0],o,s[2]),t[n]=s[0],t[n+1]=s[1],t[n+2]=s[2]}})}return t}),define("colors/threshold",["colors/base"],function(e){function t(t,n,r){e.applyFilter(t,n,function(e){var t;r+=100;for(var n=0,i=e.length;n<i;n+=4)t=.2126*e[n]+.7152*e[n+1]+.0722*e[n+2],e[n]=e[n+1]=e[n+2]=t>=r?255:0})}return t}),define("colors/colors",["colors/brightness","colors/contrast","colors/hue","colors/saturation","colors/threshold"],function(e,t,n,r,i){return{brightness:e,contrast:t,hue:n,saturation:r,threshold:i}}),define("slider",[],function(){function r(r,o,u,a){var f="ontouchstart"in window;f&&$(".header-wrap").hide(),n=s(),e=r,t=$("<canvas>")[0],t.width=e.width,t.height=e.height;var l=t.getContext("2d");l.drawImage(e,0,0);var c=function(e){var n=l.getImageData(0,0,t.width,t.height);o(e,n)};n.on("click","#OKButton",function(){i(),u&&u()}).on("click","#CancelButton",function(){i(),a&&a()});if(o){var h=f?"touchstart":"mousedown",p=f?"touchmove":"mousemove",d=f?"touchend":"mouseup";n.on(h,".slider-handle",function(e){var t=this,n=f?e.originalEvent.touches[0].clientX:e.clientX,r=parseInt($(t).css("left"),10),i=0;$(document).on(p+".slider",function(e){e.preventDefault();var s=f?e.originalEvent.targetTouches[0].clientX:e.clientX;i=s-n+r-100,i=Math.max(-100,Math.min(100,i)),$(t).css("left",100+i),f||c(i)}).on(d+".slider",function(e){$(document).off(".slider"),c(i)})}),c(0)}}function i(){n&&n.off().remove(),"ontouchstart"in window&&$(".header-wrap").show(),n=null,t=null}function s(){var e=$('<div class="actions-wrap"><div class="slider-wrap"><div class="slider-line"></div><div class="slider-handle"></div></div><div class="buttons-wrap"><ul class="buttons-list"><li id="OKButton"><span class="icon icon-ok"></span></li><li id="CancelButton"><span class="icon icon-cancel"></span></li></ul></div></div>').appendTo($(".content-wrap"));return e}var e,t,n;return{show:r,hide:i}}),requirejs.config({baseUrl:"scripts",paths:{canvasToBlob:"lib/canvastoblob",fileSaver:"lib/filesaver"}}),require(["view","fileIO","filters/filters","transforms/transforms","cache/cache","zoom/zoom","crop","colors/colors","slider"],function(e,t,n,r,i,s,o,u,a){function f(){a.hide(),o.hide(),i.current()}function l(){i.init(canvas),s.init(canvas,c),e.init($(".body-wrap"))}function c(e){o.hide(),zoomList.children[1].textContent=e+"%"}function p(t){n[t](canvas),e.isTouch()||i.store()}function d(t){r[t](canvas),s.refreshZoomWrap(),e.isTouch()||i.store()}function v(e){a.hide(),o.hide(),i[e](),s.refreshZoomWrap()}function m(t,n){a.hide(),i.current();var r=function(){$(".toolbar-secondary-wrap .selected").removeClass("selected")};a.show(canvas,function(t,r){u[n](canvas,r,t)},function(){e.isTouch()||i.store(),r()},function(){i.current(),r()}),$(t).parent().find(".selected").removeClass("selected"),$(t).addClass("selected")}function g(){function n(){e.isTouch()?(e.restore(),t.css({top:"0"})):($("#cropButton").removeClass("selected"),t.css({bottom:"0"}))}var t=$(".canvas-wrap");e.isTouch()?t.css({top:"80px"}):t.css({bottom:"100px"}),(t.width()<$(".zoom-wrap").width()||t.height()<$(".zoom-wrap").height())&&s.fitZoom(),o.crop(canvas,s.getZoomLevel(),function(){s.refreshZoomWrap(),i.store(),n()},function(){n()})}function y(t,n){e.isTouch()||f(),e.show(t,n)}$(".body-wrap").addClass(e.isTouch()?"touch":"desktop"),$(".loading-screen").remove();var h;loadFile.onchange=function(){f();if(!this.files.length)return;h=this.files[0].name,t.loadFile(this,canvas,l)},downloadButton.onclick=function(){f(),t.saveFile(canvas,h)},invertButton.onclick=function(){p("invert")},grayscaleButton.onclick=function(){p("grayscale")},blurButton.onclick=function(){p("blur")},sharpenButton.onclick=function(){p("sharpen")},embossButton.onclick=function(){p("emboss")},edgeButton.onclick=function(){p("edge")},sobelButton.onclick=function(){p("sobel")},erodeButton.onclick=function(){p("erode")},dilateButton.onclick=function(){p("dilate")},medianButton.onclick=function(){p("median")},flipHorizontalButton.onclick=function(){d("flipHorizontal")},flipVerticalButton.onclick=function(){d("flipVertical")},rotate90Button.onclick=function(){d("rotate90")},rotate180Button.onclick=function(){d("rotate180")},rotate270Button.onclick=function(){d("rotate270")},undoButton.onclick=function(){v("undo")},redoButton.onclick=function(){v("redo")},resetButton.onclick=function(){v("reset")},zoomOutButton.onclick=function(){s.stepZoom(-1)},zoomInButton.onclick=function(){s.stepZoom(1)},zoomFitButton.onclick=function(){s.fitZoom()},brightnessButton.onclick=function(){m(this,"brightness")},contrastButton.onclick=function(){m(this,"contrast")},hueButton.onclick=function(){m(this,"hue")},saturationButton.onclick=function(){m(this,"saturation")},thresholdButton.onclick=function(){m(this,"threshold")},applyButton.onclick=function(){i.store(),e.restore()},restoreButton.onclick=function(){i.current(),e.restore()},transformButton.onclick=function(){y(transformList,this)},filterButton.onclick=function(){y(filterList,this)},colorButton.onclick=function(){y(colorList,this)},cropButton.onclick=function(){y(null,this),g()},window.onbeforeunload=function(e){s.disposeEvents()},l()}),define("app",function(){});